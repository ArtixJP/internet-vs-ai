<!DOCTYPE html>

<html>
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://esm.run https://cdn.tailwindcss.com https://threejs.org https://cdn.threejs.org https://cdn.p5js.org https://code.jquery.com https://d3js.org https://cdn.plot.ly https://cdn.tonejs.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: https:; media-src 'self' https:; font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; worker-src 'self'; frame-src https://www.youtube.com https://www.youtube-nocookie.com https://player.vimeo.com; connect-src 'self' https: wss: ws:; object-src 'none'; base-uri 'self'; form-action 'self';">
<title>Collective Craft</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 50%, #87CEEB 100%);
        color: #333;
        font-family: 'Courier New', monospace;
        padding: 10px;
        gap: 10px;
        overflow: hidden;
        transition: background 2s;
    }
    body.night {
        background: linear-gradient(180deg, #0a0a20 0%, #1a1a40 50%, #0f0f30 100%);
    }
    h1 {
        font-size: 1.8rem;
        color: #2d5a27;
        text-shadow: 2px 2px 0 #5a8f52, 4px 4px 0 rgba(0,0,0,0.2);
        font-weight: bold;
        letter-spacing: 2px;
        image-rendering: pixelated;
    }
    body.night h1 { color: #7ec850; }
    .world-container {
        perspective: 1000px;
        transform-style: preserve-3d;
    }
    #world {
        display: grid;
        grid-template-columns: repeat(24, 22px);
        grid-template-rows: repeat(14, 22px);
        gap: 1px;
        background: #3d2817;
        padding: 4px;
        border: 4px solid #2a1a0a;
        box-shadow: 8px 8px 0 rgba(0,0,0,0.3), inset 0 0 20px rgba(0,0,0,0.2);
        transform: rotateX(5deg);
        image-rendering: pixelated;
    }
    .block {
        width: 22px;
        height: 22px;
        position: relative;
        transition: transform 0.1s, filter 0.1s;
        cursor: pointer;
        image-rendering: pixelated;
    }
    .block:hover {
        transform: translateY(-2px);
        filter: brightness(1.2);
    }
    .block.placed {
        animation: blockPlace 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .block.mined {
        animation: blockMine 0.4s ease-out forwards;
    }
    @keyframes blockPlace {
        0% { transform: scale(0) translateY(-20px); }
        60% { transform: scale(1.2) translateY(0); }
        100% { transform: scale(1) translateY(0); }
    }
    @keyframes blockMine {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.3) rotate(10deg); }
        100% { transform: scale(0) rotate(45deg); opacity: 0; }
    }
    /* Block types */
    .block.air { background: transparent; }
    .block.grass {
        background: linear-gradient(180deg, #5a8f52 0%, #5a8f52 30%, #8b6914 30%, #8b6914 100%);
        box-shadow: inset 2px 2px 0 rgba(255,255,255,0.2), inset -2px -2px 0 rgba(0,0,0,0.2);
    }
    .block.dirt {
        background: #8b6914;
        box-shadow: inset 2px 2px 0 rgba(255,255,255,0.1), inset -2px -2px 0 rgba(0,0,0,0.2);
    }
    .block.stone {
        background: linear-gradient(135deg, #8a8a8a 25%, #6a6a6a 50%, #7a7a7a 75%);
        box-shadow: inset 2px 2px 0 rgba(255,255,255,0.2), inset -2px -2px 0 rgba(0,0,0,0.3);
    }
    .block.wood {
        background: repeating-linear-gradient(0deg, #6b4423 0px, #8b5a2b 4px, #6b4423 8px);
        box-shadow: inset 2px 2px 0 rgba(255,255,255,0.1), inset -2px -2px 0 rgba(0,0,0,0.2);
    }
    .block.leaves {
        background: #2d5a27;
        box-shadow: inset 2px 2px 0 rgba(100,200,100,0.3), inset -2px -2px 0 rgba(0,0,0,0.2);
    }
    .block.water {
        background: linear-gradient(180deg, rgba(30,144,255,0.7) 0%, rgba(0,100,200,0.8) 100%);
        animation: waterFlow 2s ease-in-out infinite;
    }
    @keyframes waterFlow {
        0%, 100% { opacity: 0.8; }
        50% { opacity: 0.95; }
    }
    .block.sand {
        background: #e8d174;
        box-shadow: inset 2px 2px 0 rgba(255,255,255,0.3), inset -2px -2px 0 rgba(0,0,0,0.1);
    }
    .block.cobble {
        background: repeating-conic-gradient(#6a6a6a 0deg 90deg, #5a5a5a 90deg 180deg) 0 0/10px 10px;
        box-shadow: inset 2px 2px 0 rgba(255,255,255,0.1), inset -2px -2px 0 rgba(0,0,0,0.3);
    }
    .block.brick {
        background: repeating-linear-gradient(0deg, #8b4513 0px, #a0522d 10px), 
                    repeating-linear-gradient(90deg, transparent 0px, transparent 10px, #5a3010 10px, #5a3010 11px);
        box-shadow: inset 2px 2px 0 rgba(255,255,255,0.1), inset -2px -2px 0 rgba(0,0,0,0.2);
    }
    .block.gold {
        background: linear-gradient(135deg, #ffd700 0%, #ffec8b 50%, #daa520 100%);
        box-shadow: inset 2px 2px 0 rgba(255,255,255,0.5), inset -2px -2px 0 rgba(0,0,0,0.2);
        animation: goldShine 3s ease-in-out infinite;
    }
    @keyframes goldShine {
        0%, 100% { filter: brightness(1); }
        50% { filter: brightness(1.3); }
    }
    .block.diamond {
        background: linear-gradient(135deg, #4ee4e4 0%, #00ffff 50%, #20b2aa 100%);
        box-shadow: inset 2px 2px 0 rgba(255,255,255,0.6), inset -2px -2px 0 rgba(0,0,0,0.2);
        animation: diamondSparkle 2s ease-in-out infinite;
    }
    @keyframes diamondSparkle {
        0%, 100% { filter: brightness(1) saturate(1); }
        50% { filter: brightness(1.4) saturate(1.2); }
    }
    .block.tnt {
        background: #ff0000;
        box-shadow: inset 5px 0 0 #fff, inset 10px 0 0 #ff0000, inset 15px 0 0 #fff;
    }
    .mario {
        position: absolute;
        width: 20px;
        height: 26px;
        z-index: 100;
        transition: left 0.15s ease-out, bottom 0.1s ease-out;
        image-rendering: pixelated;
        pointer-events: none;
    }
    .mario-sprite {
        width: 100%;
        height: 100%;
        background: linear-gradient(180deg, 
            #ff0000 0%, #ff0000 30%, 
            #ffcc99 30%, #ffcc99 45%,
            #ff0000 45%, #ff0000 60%,
            #0066cc 60%, #0066cc 85%,
            #8b4513 85%, #8b4513 100%);
        border-radius: 4px 4px 0 0;
        position: relative;
    }
    .mario-sprite::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 50%;
        transform: translateX(-50%);
        width: 14px;
        height: 6px;
        background: #ff0000;
        border-radius: 50% 50% 0 0;
    }
    .mario-sprite::after {
        content: '';
        position: absolute;
        top: 8px;
        left: 4px;
        width: 4px;
        height: 3px;
        background: #000;
        border-radius: 50%;
        box-shadow: 8px 0 0 #000;
    }
    .mario.jumping {
        animation: marioJump 0.5s ease-out;
    }
    .mario.left .mario-sprite {
        transform: scaleX(-1);
    }
    @keyframes marioJump {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-40px); }
    }
    .block.lava {
        background: linear-gradient(180deg, #ff4500 0%, #ff6600 50%, #ff0000 100%);
        animation: lavaGlow 1s ease-in-out infinite;
    }
    @keyframes lavaGlow {
        0%, 100% { filter: brightness(1); }
        50% { filter: brightness(1.5); }
    }
    .palette {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        justify-content: center;
        max-width: 600px;
        background: rgba(60,40,20,0.9);
        padding: 8px 12px;
        border-radius: 4px;
        border: 3px solid #2a1a0a;
    }
    .block-btn {
        width: 28px;
        height: 28px;
        border: 2px solid #1a0a00;
        cursor: pointer;
        transition: transform 0.1s;
        image-rendering: pixelated;
    }
    .block-btn:hover {
        transform: scale(1.2);
    }
    .block-btn::after {
        content: attr(data-name);
        position: absolute;
        bottom: -16px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 8px;
        color: #fff;
        text-shadow: 1px 1px 0 #000;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .block-btn:hover::after { opacity: 1; }
    .instructions {
        background: rgba(60,40,20,0.9);
        padding: 8px 16px;
        border: 3px solid #2a1a0a;
        font-size: 0.85rem;
        text-align: center;
        color: #e8d174;
    }
    .instructions code {
        background: #1a0a00;
        padding: 2px 6px;
        color: #5a8f52;
    }
    .activity-log {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: rgba(30,20,10,0.95);
        padding: 8px;
        border: 2px solid #5a3a1a;
        font-size: 10px;
        max-width: 180px;
        max-height: 80px;
        overflow: hidden;
        color: #e8d174;
    }
    .stats {
        font-size: 0.75rem;
        color: #5a8f52;
        background: rgba(0,0,0,0.3);
        padding: 4px 8px;
        border-radius: 2px;
    }
    body.night .stats { color: #7ec850; }
    .day-cycle {
        position: fixed;
        top: 10px;
        right: 10px;
        font-size: 1.5rem;
        background: rgba(0,0,0,0.3);
        padding: 5px 10px;
        border-radius: 4px;
    }
    .clouds {
        position: fixed;
        top: 20px;
        left: 0;
        width: 100%;
        height: 60px;
        pointer-events: none;
        overflow: hidden;
        opacity: 0.8;
    }
    .cloud {
        position: absolute;
        background: #fff;
        border-radius: 20px;
        animation: cloudMove 30s linear infinite;
    }
    @keyframes cloudMove {
        0% { transform: translateX(-100px); }
        100% { transform: translateX(calc(100vw + 100px)); }
    }
    body.night .clouds { opacity: 0.2; }
    .experiment-info {
        background: rgba(60,40,20,0.9);
        border: 3px solid #5a8f52;
        padding: 10px 14px;
        max-width: 480px;
        font-size: 0.75rem;
        line-height: 1.4;
        text-align: center;
        color: #e8d174;
    }
    .experiment-info h3 {
        color: #5a8f52;
        margin-bottom: 6px;
    }
    .experiment-info .highlight { color: #ffd700; }
</style>
</head>
<body>
<div class="clouds">
<div class="cloud" style="width:80px;height:30px;top:10px;left:10%;animation-delay:0s;"></div>
<div class="cloud" style="width:120px;height:40px;top:25px;left:40%;animation-delay:-10s;"></div>
<div class="cloud" style="width:60px;height:25px;top:5px;left:70%;animation-delay:-20s;"></div>
</div>
<div class="day-cycle" id="dayCycle">‚òÄÔ∏è</div>
<h1>‚õèÔ∏è COLLECTIVE CRAFT ‚õèÔ∏è</h1>
<div class="experiment-info">
<h3>üåê Internet vs AI Experiment ü§ñ</h3>
<p>A <span class="highlight">live Minecraft-style world</span> built by chat!</p>
<p>Type <code>!idea your suggestion</code> to evolve this page with AI!</p>
</div>
<div class="instructions">
<code>place [block] [x] [y]</code> ¬∑ <code>mine [x] [y]</code> ¬∑ <code>left/right/jump</code><br/>
    Example: <code>place diamond 10 5</code> ¬∑ <code>jump</code> to control Mario!
</div>
<div class="palette">
<div class="block-btn grass" data-name="grass"></div>
<div class="block-btn dirt" data-name="dirt"></div>
<div class="block-btn stone" data-name="stone"></div>
<div class="block-btn cobble" data-name="cobble"></div>
<div class="block-btn wood" data-name="wood"></div>
<div class="block-btn leaves" data-name="leaves"></div>
<div class="block-btn sand" data-name="sand"></div>
<div class="block-btn water" data-name="water"></div>
<div class="block-btn brick" data-name="brick"></div>
<div class="block-btn gold" data-name="gold"></div>
<div class="block-btn diamond" data-name="diamond"></div>
<div class="block-btn lava" data-name="lava"></div>
<div class="block-btn tnt" data-name="tnt"></div>
</div>
<div class="world-container">
<div id="world"></div>
<div class="mario" id="mario">
<div class="mario-sprite"></div>
</div>
</div>
<div class="stats">Blocks placed: <span id="count">0</span> | Day <span id="day">1</span></div>
<div class="activity-log" id="log">üî¥ Connecting...</div>
<script>
    const blockTypes = ['air','grass','dirt','stone','cobble','wood','leaves','sand','water','brick','gold','diamond','lava','tnt'];
    const world = document.getElementById('world');
    const log = document.getElementById('log');
    const countEl = document.getElementById('count');
    const dayEl = document.getElementById('day');
    const dayCycleEl = document.getElementById('dayCycle');
    let blockCount = 0;
    let dayCount = 1;
    let isNight = false;
    const WIDTH = 24, HEIGHT = 14;
    const grid = [];

    // Generate procedural terrain
    function generateTerrain() {
        const terrain = [];
        let height = 7;
        for (let x = 0; x < WIDTH; x++) {
            height += Math.floor(Math.random() * 3) - 1;
            height = Math.max(4, Math.min(10, height));
            terrain.push(height);
        }
        return terrain;
    }
    const terrainHeights = generateTerrain();

    // Create world grid
    for (let y = 0; y < HEIGHT; y++) {
        grid[y] = [];
        for (let x = 0; x < WIDTH; x++) {
            const block = document.createElement('div');
            block.className = 'block air';
            block.dataset.x = x;
            block.dataset.y = y;
            
            const groundLevel = terrainHeights[x];
            if (y === groundLevel) {
                block.className = 'block grass';
                grid[y][x] = 'grass';
            } else if (y > groundLevel && y < groundLevel + 3) {
                block.className = 'block dirt';
                grid[y][x] = 'dirt';
            } else if (y >= groundLevel + 3) {
                block.className = 'block stone';
                grid[y][x] = 'stone';
            } else {
                grid[y][x] = 'air';
            }
            world.appendChild(block);
        }
    }

    // Add a tree
    function addTree(tx) {
        const groundY = terrainHeights[tx];
        if (tx > 1 && tx < WIDTH - 2 && groundY > 3) {
            for (let ty = groundY - 4; ty < groundY; ty++) {
                if (ty >= 0) setBlock(tx, ty, 'wood', false);
            }
            for (let ly = groundY - 6; ly < groundY - 3; ly++) {
                for (let lx = tx - 2; lx <= tx + 2; lx++) {
                    if (lx >= 0 && lx < WIDTH && ly >= 0 && Math.random() > 0.2) {
                        if (grid[ly][lx] === 'air') setBlock(lx, ly, 'leaves', false);
                    }
                }
            }
        }
    }
    addTree(5);
    addTree(18);

    // Add water pool
    for (let wx = 10; wx < 14; wx++) {
        const wy = terrainHeights[wx];
        setBlock(wx, wy, 'water', false);
    }

    function setBlock(x, y, type, animate = true) {
        if (x < 0 || x >= WIDTH || y < 0 || y >= HEIGHT) return false;
        if (!blockTypes.includes(type)) return false;
        const block = world.children[y * WIDTH + x];
        if (block) {
            block.className = 'block ' + type;
            if (animate) {
                block.classList.add('placed');
                setTimeout(() => block.classList.remove('placed'), 300);
            }
            grid[y][x] = type;
            return true;
        }
        return false;
    }

    function placeBlock(type, x, y, user) {
        if (setBlock(x, y, type)) {
            blockCount++;
            countEl.textContent = blockCount;
            addLog(`${user}: +${type} @${x},${y}`);
            playSound(type);
            if (type === 'tnt') setTimeout(() => explode(x, y), 2000);
        }
    }

    function mineBlock(x, y, user) {
        if (x < 0 || x >= WIDTH || y < 0 || y >= HEIGHT) return;
        const block = world.children[y * WIDTH + x];
        if (block && grid[y][x] !== 'air') {
            const oldType = grid[y][x];
            block.classList.add('mined');
            playSound('mine');
            setTimeout(() => {
                block.className = 'block air';
                grid[y][x] = 'air';
            }, 400);
            addLog(`${user}: -${oldType} @${x},${y}`);
        }
    }

    function explode(cx, cy) {
        playSound('explode');
        for (let dy = -2; dy <= 2; dy++) {
            for (let dx = -2; dx <= 2; dx++) {
                if (Math.abs(dx) + Math.abs(dy) <= 3) {
                    const x = cx + dx, y = cy + dy;
                    if (x >= 0 && x < WIDTH && y >= 0 && y < HEIGHT) {
                        const block = world.children[y * WIDTH + x];
                        if (block) {
                            block.classList.add('mined');
                            setTimeout(() => {
                                block.className = 'block air';
                                grid[y][x] = 'air';
                            }, 200 + Math.random() * 300);
                        }
                    }
                }
            }
        }
        addLog('üí• TNT EXPLODED!');
    }

    function addLog(msg) {
        log.innerHTML = msg + '<br>' + log.innerHTML.split('<br>').slice(0, 5).join('<br>');
    }

    // Day/night cycle
    setInterval(() => {
        isNight = !isNight;
        document.body.classList.toggle('night', isNight);
        dayCycleEl.textContent = isNight ? 'üåô' : '‚òÄÔ∏è';
        if (!isNight) {
            dayCount++;
            dayEl.textContent = dayCount;
        }
    }, 60000);

    // Smooth Audio System
    let audioCtx = null;
    function playSound(type) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const osc2 = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        const filter = audioCtx.createBiquadFilter();
        const freqs = { grass: 220, dirt: 165, stone: 110, wood: 196, leaves: 330, water: 440, sand: 247, cobble: 131, brick: 147, gold: 659, diamond: 880, lava: 82, tnt: 65, mine: 98, explode: 55, jump: 523, step: 196 };
        const baseFreq = freqs[type] || 220;
        osc.frequency.value = baseFreq;
        osc2.frequency.value = baseFreq * 1.5;
        osc.type = 'sine';
        osc2.type = 'triangle';
        filter.type = 'lowpass';
        filter.frequency.value = 2000;
        filter.Q.value = 1;
        gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
        osc.connect(filter);
        osc2.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc2.start();
        osc.stop(audioCtx.currentTime + 0.4);
        osc2.stop(audioCtx.currentTime + 0.4);
    }

    // Mario Controller
    const mario = document.getElementById('mario');
    let marioX = 12;
    let marioY = 0;
    let marioDir = 'right';
    let isJumping = false;

    function updateMarioPosition() {
        const groundY = findGround(marioX);
        marioY = groundY;
        const worldRect = world.getBoundingClientRect();
        const blockSize = 23;
        mario.style.left = (marioX * blockSize + 4) + 'px';
        mario.style.bottom = ((HEIGHT - marioY) * blockSize - 4) + 'px';
    }

    function findGround(x) {
        for (let y = 0; y < HEIGHT; y++) {
            if (grid[y] && grid[y][x] && grid[y][x] !== 'air' && grid[y][x] !== 'water') {
                return y;
            }
        }
        return HEIGHT - 1;
    }

    function moveMario(dir, user) {
        if (dir === 'left' && marioX > 0) {
            marioX--;
            marioDir = 'left';
            mario.classList.add('left');
            mario.classList.remove('right');
            playSound('step');
            addLog(`${user}: Mario ‚Üê`);
        } else if (dir === 'right' && marioX < WIDTH - 1) {
            marioX++;
            marioDir = 'right';
            mario.classList.remove('left');
            playSound('step');
            addLog(`${user}: Mario ‚Üí`);
        } else if (dir === 'jump' && !isJumping) {
            isJumping = true;
            mario.classList.add('jumping');
            playSound('jump');
            addLog(`${user}: Mario ‚Üë`);
            setTimeout(() => {
                mario.classList.remove('jumping');
                isJumping = false;
            }, 500);
        }
        updateMarioPosition();
    }

    updateMarioPosition();
    setInterval(updateMarioPosition, 500);

    // WebSocket
    const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const pathBase = location.pathname.includes('/twitch_plays_code') ? '/twitch_plays_code' : 
                     location.pathname.includes('/tpc') ? '/twitch_plays_code' : '';
    const chatWs = new WebSocket(`${wsProtocol}//${location.host}${pathBase}/ws/chat`);

    chatWs.onopen = () => { log.innerHTML = 'üü¢ World online!'; };
    chatWs.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'chat_message') {
            const txt = msg.message.toLowerCase();
            const placeMatch = txt.match(/place\s+(\w+)\s+(\d+)\s+(\d+)/);
            const mineMatch = txt.match(/mine\s+(\d+)\s+(\d+)/);
            if (placeMatch) {
                placeBlock(placeMatch[1], parseInt(placeMatch[2]), parseInt(placeMatch[3]), msg.username);
            } else if (mineMatch) {
                mineBlock(parseInt(mineMatch[1]), parseInt(mineMatch[2]), msg.username);
            } else if (txt.includes('left')) {
                moveMario('left', msg.username);
            } else if (txt.includes('right')) {
                moveMario('right', msg.username);
            } else if (txt.includes('jump')) {
                moveMario('jump', msg.username);
            }
        }
    };
    chatWs.onerror = () => { log.innerHTML = 'üî¥ Connection lost'; };
</script>
</body>
</html>