<!DOCTYPE html>

<html>
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://esm.run https://cdn.tailwindcss.com https://threejs.org https://cdn.threejs.org https://cdn.p5js.org https://code.jquery.com https://d3js.org https://cdn.plot.ly https://cdn.tonejs.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: https:; media-src 'self' https:; font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; worker-src 'self'; frame-src https://www.youtube.com https://www.youtube-nocookie.com https://player.vimeo.com; connect-src 'self' https: wss: ws:; object-src 'none'; base-uri 'self'; form-action 'self';">
<title>Minecraft 3D World</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{overflow:hidden;background:#000}
canvas{display:block}
#ui{position:absolute;top:10px;left:10px;color:#fff;font-family:'Courier New',monospace;text-shadow:2px 2px 0 #000;z-index:100}
#crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:24px;z-index:100;pointer-events:none}
#controls{position:absolute;bottom:10px;left:10px;color:#fff;font-family:'Courier New',monospace;background:rgba(0,0,0,0.6);padding:10px;border-radius:4px;font-size:12px}
#mode-btn{position:absolute;top:10px;right:10px;padding:10px 20px;background:#5d8c3e;color:#fff;border:none;font-family:'Courier New',monospace;cursor:pointer;font-size:14px;border-radius:4px}
#mode-btn:hover{background:#4a7030}
</style>
</head>
<body>
<div id="ui">‚õèÔ∏è MINECRAFT 3D<br/><span id="pos"></span><br/><span id="quake" style="color:#ff6b6b;font-size:10px"></span></div>
<div id="crosshair">+</div>
<div id="controls">WASD: Move | SPACE: Jump | SHIFT: Down<br/>CLICK: Break block | RIGHT-CLICK: Place<br/>1-4: Select block type</div>
<button id="mode-btn">üéÆ MANUAL MODE</button>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
const CHUNK=16,WORLD=4,BLOCK=1;
let scene,camera,renderer,blocks={},player,velocity={x:0,y:0,z:0},onGround=false;
let keys={},selectedBlock=1,autoMode=false,autoTime=0,shakeIntensity=0,shakeTime=0;
const blockTypes={1:{color:0x5d8c3e,name:'Grass'},2:{color:0x8b5a2b,name:'Dirt'},3:{color:0x808080,name:'Stone'},4:{color:0x8B4513,name:'Wood'}};

function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x87CEEB);
  scene.fog=new THREE.Fog(0x87CEEB,20,80);
  
  camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
  camera.position.set(CHUNK*WORLD/2,20,CHUNK*WORLD/2);
  
  renderer=new THREE.WebGLRenderer({antialias:false});
  renderer.setSize(innerWidth,innerHeight);
  renderer.setPixelRatio(1);
  document.body.appendChild(renderer.domElement);
  
  const ambient=new THREE.AmbientLight(0xffffff,0.6);
  scene.add(ambient);
  const sun=new THREE.DirectionalLight(0xffffff,0.8);
  sun.position.set(50,100,50);
  scene.add(sun);
  
  generateTerrain();
  player={x:CHUNK*WORLD/2,y:25,z:CHUNK*WORLD/2,yaw:0,pitch:0};
  
  document.addEventListener('keydown',e=>keys[e.code]=true);
  document.addEventListener('keyup',e=>keys[e.code]=false);
  document.addEventListener('click',onClick);
  document.addEventListener('contextmenu',e=>{e.preventDefault();placeBlock();});
  document.addEventListener('mousemove',onMouse);
  document.addEventListener('keydown',e=>{if(e.key>='1'&&e.key<='4')selectedBlock=+e.key;});
  document.getElementById('mode-btn').onclick=toggleMode;
  
  renderer.domElement.onclick=()=>renderer.domElement.requestPointerLock();
  window.onresize=()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);};
  
  animate();
}

function noise(x,z){
  return Math.sin(x*0.1)*Math.cos(z*0.1)*3+Math.sin(x*0.05+z*0.05)*5+8;
}

function generateTerrain(){
  const geo=new THREE.BoxGeometry(BLOCK,BLOCK,BLOCK);
  for(let x=0;x<CHUNK*WORLD;x++){
    for(let z=0;z<CHUNK*WORLD;z++){
      const h=Math.floor(noise(x,z));
      for(let y=0;y<=h;y++){
        const type=y===h?1:y>h-3?2:3;
        addBlock(x,y,z,type);
      }
    }
  }
  // Add some trees
  for(let i=0;i<30;i++){
    const tx=Math.floor(Math.random()*CHUNK*WORLD);
    const tz=Math.floor(Math.random()*CHUNK*WORLD);
    const th=Math.floor(noise(tx,tz))+1;
    for(let ty=0;ty<5;ty++)addBlock(tx,th+ty,tz,4);
    for(let lx=-2;lx<=2;lx++)for(let lz=-2;lz<=2;lz++)for(let ly=0;ly<2;ly++){
      if(Math.abs(lx)+Math.abs(lz)<4)addBlock(tx+lx,th+5+ly,tz+lz,1);
    }
  }
}

function addBlock(x,y,z,type){
  const key=`${x},${y},${z}`;
  if(blocks[key])return;
  const geo=new THREE.BoxGeometry(BLOCK,BLOCK,BLOCK);
  const mat=new THREE.MeshLambertMaterial({color:blockTypes[type].color});
  const mesh=new THREE.Mesh(geo,mat);
  mesh.position.set(x,y,z);
  mesh.userData={type,key};
  scene.add(mesh);
  blocks[key]=mesh;
}

function removeBlock(key){
  if(blocks[key]){
    scene.remove(blocks[key]);
    delete blocks[key];
  }
}

function getBlock(x,y,z){
  return blocks[`${Math.floor(x)},${Math.floor(y)},${Math.floor(z)}`];
}

function onClick(){
  if(autoMode)return;
  const ray=new THREE.Raycaster();
  ray.setFromCamera({x:0,y:0},camera);
  const hits=ray.intersectObjects(Object.values(blocks));
  if(hits.length>0&&hits[0].distance<6){
    removeBlock(hits[0].object.userData.key);
  }
}

function placeBlock(){
  if(autoMode)return;
  const ray=new THREE.Raycaster();
  ray.setFromCamera({x:0,y:0},camera);
  const hits=ray.intersectObjects(Object.values(blocks));
  if(hits.length>0&&hits[0].distance<6){
    const p=hits[0].point.clone().add(hits[0].face.normal.multiplyScalar(0.5));
    addBlock(Math.floor(p.x),Math.floor(p.y),Math.floor(p.z),selectedBlock);
  }
}

function onMouse(e){
  if(document.pointerLockElement&&!autoMode){
    player.yaw-=e.movementX*0.002;
    player.pitch-=e.movementY*0.002;
    player.pitch=Math.max(-1.5,Math.min(1.5,player.pitch));
  }
}

function toggleMode(){
  autoMode=!autoMode;
  document.getElementById('mode-btn').textContent=autoMode?'üé• AUTO-EXPLORE ON':'üéÆ MANUAL MODE';
  if(!autoMode)document.exitPointerLock();
}

function collide(x,y,z){
  for(let dx=-0.3;dx<=0.3;dx+=0.6)for(let dz=-0.3;dz<=0.3;dz+=0.6){
    if(getBlock(x+dx,y,z+dz)||getBlock(x+dx,y+1,z+dz))return true;
  }
  return false;
}

function animate(){
  requestAnimationFrame(animate);
  
  if(autoMode){
    autoTime+=0.005;
    const cx=CHUNK*WORLD/2,cz=CHUNK*WORLD/2;
    const radius=25+Math.sin(autoTime*0.5)*10;
    player.x=cx+Math.cos(autoTime)*radius;
    player.z=cz+Math.sin(autoTime)*radius;
    player.y=20+Math.sin(autoTime*2)*5;
    player.yaw=autoTime+Math.PI;
    player.pitch=-0.2+Math.sin(autoTime*3)*0.1;
  }else{
    const speed=0.15,friction=0.85,gravity=0.02,smoothing=0.12;
    let targetDx=0,targetDz=0;
    if(keys['KeyW']){targetDx-=Math.sin(player.yaw)*speed;targetDz-=Math.cos(player.yaw)*speed;}
    if(keys['KeyS']){targetDx+=Math.sin(player.yaw)*speed;targetDz+=Math.cos(player.yaw)*speed;}
    if(keys['KeyA']){targetDx-=Math.cos(player.yaw)*speed;targetDz+=Math.sin(player.yaw)*speed;}
    if(keys['KeyD']){targetDx+=Math.cos(player.yaw)*speed;targetDz-=Math.sin(player.yaw)*speed;}
    
    // Smooth lerp towards target velocity
    velocity.x+=(targetDx-velocity.x)*smoothing;
    velocity.z+=(targetDz-velocity.z)*smoothing;
    // Apply friction when no input
    if(!keys['KeyW']&&!keys['KeyS']&&!keys['KeyA']&&!keys['KeyD']){velocity.x*=friction;velocity.z*=friction;}
    velocity.y-=gravity;
    
    if(keys['Space']&&onGround)velocity.y=0.25;
    if(keys['ShiftLeft'])velocity.y=-0.2;
    
    if(!collide(player.x+velocity.x,player.y,player.z))player.x+=velocity.x;
    if(!collide(player.x,player.y,player.z+velocity.z))player.z+=velocity.z;
    
    const groundCheck=getBlock(player.x,player.y-0.1,player.z);
    if(groundCheck&&velocity.y<0){velocity.y=0;onGround=true;player.y=Math.floor(player.y)+1;}
    else{onGround=false;player.y+=velocity.y;}
    
    if(player.y<-10){player.y=30;velocity.y=0;}
  }
  
  camera.position.set(player.x,player.y+1.6,player.z);
  camera.rotation.order='YXZ';
  camera.rotation.y=player.yaw;
  camera.rotation.x=player.pitch;
  
  // Earthquake shake effect
  shakeTime+=0.016;
  // Earthquake disabled for stability - if(Math.random()<0.002)shakeIntensity=0.5+Math.random()*0.5;
  if(shakeIntensity>0){
    camera.position.x+=Math.sin(shakeTime*50)*shakeIntensity*0.1;
    camera.position.y+=Math.cos(shakeTime*60)*shakeIntensity*0.05;
    camera.rotation.z=Math.sin(shakeTime*40)*shakeIntensity*0.02;
    shakeIntensity*=0.95; // Decay
    if(shakeIntensity<0.01)shakeIntensity=0;
  }else{camera.rotation.z=0;}
  
  document.getElementById('pos').textContent=`X:${player.x.toFixed(0)} Y:${player.y.toFixed(0)} Z:${player.z.toFixed(0)} [${blockTypes[selectedBlock].name}]`;
  document.getElementById('quake').textContent=shakeIntensity>0.1?'üåã EARTHQUAKE!':'';
  
  renderer.render(scene,camera);
}

init();
</script>
</body>
</html>