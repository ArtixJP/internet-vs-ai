<!DOCTYPE html>

<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://esm.run https://cdn.tailwindcss.com https://threejs.org https://cdn.threejs.org https://cdn.p5js.org https://code.jquery.com https://d3js.org https://cdn.plot.ly https://cdn.tonejs.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: https:; media-src 'self' https:; font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; worker-src 'self'; frame-src https://www.youtube.com https://www.youtube-nocookie.com https://player.vimeo.com; connect-src 'self' https: wss: ws:; object-src 'none'; base-uri 'self'; form-action 'self';">
<meta charset="utf-8"/>
<title>ğŸ± Cat Paradise ğŸ±</title>
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            min-height: 100vh;
            background: linear-gradient(180deg, #ffecd2 0%, #fcb69f 50%, #ee9ca7 100%);
            font-family: 'Comic Sans MS', 'Chalkboard', cursive, sans-serif;
            overflow-x: hidden;
            position: relative;
        }
        
        .sky {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 0;
        }
        
        .floating-cat {
            position: absolute;
            font-size: 3rem;
            animation: float 6s ease-in-out infinite;
            cursor: pointer;
            pointer-events: auto;
            transition: transform 0.3s;
        }
        .floating-cat:hover { transform: scale(1.3) rotate(10deg); }
        .floating-cat:nth-child(1) { top: 10%; left: 15%; animation-delay: 0s; }
        .floating-cat:nth-child(2) { top: 25%; right: 20%; animation-delay: 1s; font-size: 2.5rem; }
        .floating-cat:nth-child(3) { top: 60%; left: 8%; animation-delay: 2s; font-size: 4rem; }
        .floating-cat:nth-child(4) { top: 40%; right: 10%; animation-delay: 0.5s; }
        .floating-cat:nth-child(5) { bottom: 20%; left: 25%; animation-delay: 3s; font-size: 2rem; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        
        .main-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            min-height: 100vh;
        }
        
        h1 {
            font-size: 3.5rem;
            color: #5d4e60;
            text-shadow: 3px 3px 0 #fff, -1px -1px 0 #ffb6c1;
            margin-bottom: 10px;
            animation: wiggle 2s ease-in-out infinite;
        }
        
        @keyframes wiggle {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }
        
        .subtitle {
            font-size: 1.3rem;
            color: #8b7d8b;
            margin-bottom: 30px;
        }
        
        .cat-gallery {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 900px;
        }
        
        .cat-card {
            background: rgba(255,255,255,0.85);
            border-radius: 20px;
            padding: 20px;
            width: 180px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .cat-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        .cat-card.visiting {
            animation: visitBounce 0.6s ease-in-out;
        }
        .cat-card .interaction-bubble {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            white-space: nowrap;
            animation: bubblePop 2s forwards;
            z-index: 10;
        }
        .heart-trail {
            position: absolute;
            font-size: 1.2rem;
            pointer-events: none;
            animation: heartFloat 1.5s ease-out forwards;
        }
        @keyframes visitBounce {
            0%, 100% { transform: translateY(0) rotate(0); }
            25% { transform: translateY(-8px) rotate(-3deg); }
            75% { transform: translateY(-5px) rotate(3deg); }
        }
        @keyframes bubblePop {
            0% { opacity: 0; transform: translateX(-50%) scale(0.5); }
            15% { opacity: 1; transform: translateX(-50%) scale(1.1); }
            25% { transform: translateX(-50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
        @keyframes heartFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-40px) scale(0.5); }
        }
        .cat-card .emoji { font-size: 4rem; }
        .cat-card h3 { color: #5d4e60; margin: 10px 0 5px; }
        .cat-card p { font-size: 0.9rem; color: #999; }
        
        .weird-cat {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 50%, #80deea 100%) !important;
            border: 3px dashed #00bcd4;
            animation: weirdPulse 2s ease-in-out infinite;
        }
        .weird-cat .emoji {
            animation: weirdSpin 4s linear infinite;
        }
        @keyframes weirdPulse {
            0%, 100% { box-shadow: 0 0 10px #00bcd4, 0 8px 25px rgba(0,0,0,0.1); }
            50% { box-shadow: 0 0 25px #00bcd4, 0 0 40px #4dd0e1, 0 8px 25px rgba(0,0,0,0.1); }
        }
        @keyframes weirdSpin {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(5deg) scale(1.1); }
            50% { transform: rotate(0deg) scale(1); }
            75% { transform: rotate(-5deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }
        .chat-bubble {
            margin-top: 10px;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(0,188,212,0.3) 0%, rgba(0,150,180,0.25) 100%);
            border-radius: 15px;
            border: 2px solid rgba(0,188,212,0.5);
            font-size: 0.8rem;
            color: #004d54;
            max-width: 160px;
            word-wrap: break-word;
            min-height: 24px;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,188,212,0.3);
        }
        .chat-bubble::before {
            content: 'ğŸ’¬';
            position: absolute;
            top: -8px;
            left: 8px;
            font-size: 0.7rem;
        }
        .chat-bubble.new-message {
            animation: bubbleWiggle 0.5s ease-in-out;
        }
        @keyframes bubbleWiggle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); background: rgba(0,188,212,0.4); }
        }
        
        .paw-prints {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            pointer-events: none;
            opacity: 0.4;
        }
        .paw { font-size: 1.5rem; animation: step 1s ease-in-out infinite alternate; }
        .paw:nth-child(odd) { animation-delay: 0.5s; }
        
        @keyframes step {
            from { opacity: 0.3; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1.1); }
        }
        
        .community-zone {
            margin-top: 40px;
            padding: 25px;
            background: rgba(255,255,255,0.6);
            border-radius: 25px;
            border: 3px dashed #ffb6c1;
            max-width: 600px;
            text-align: center;
        }
        .community-zone h2 { color: #d4798b; margin-bottom: 10px; }
        
        .battle-arena {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255,100,100,0.2) 0%, rgba(100,100,255,0.2) 100%);
            border-radius: 25px;
            border: 4px solid #ff6b6b;
            max-width: 700px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255,100,100,0.3);
        }
        .battle-arena h2 {
            color: #c0392b;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0 #fff;
            animation: battlePulse 1s ease-in-out infinite;
        }
        @keyframes battlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); text-shadow: 2px 2px 10px #ff6b6b; }
        }
        #battle-canvas {
            background: linear-gradient(180deg, #87ceeb 0%, #98fb98 70%, #8b4513 100%);
            border-radius: 15px;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.2), 0 5px 20px rgba(0,0,0,0.3);
        }
        .battle-stats {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-top: 15px;
            font-size: 1.3rem;
            font-weight: bold;
        }
        .cat-score { color: #e74c3c; }
        .dog-score { color: #3498db; }
        .vs-text {
            color: #f39c12;
            font-size: 1.5rem;
            text-shadow: 2px 2px 0 #fff;
            animation: vsFlash 0.5s ease-in-out infinite alternate;
        }
        @keyframes vsFlash {
            from { transform: scale(1); }
            to { transform: scale(1.2); }
        }
        .community-zone p { color: #8b7d8b; }
        
        .game-zone {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.8);
            border-radius: 25px;
            border: 4px solid #ffb6c1;
            max-width: 700px;
            text-align: center;
        }
        .game-zone h2 { color: #d4798b; margin-bottom: 15px; }
        #game-canvas {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 15px;
            cursor: none;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        .game-score {
            font-size: 1.2rem;
            color: #5d4e60;
            margin-top: 10px;
        }
        .game-cat {
            position: absolute;
            font-size: 2rem;
            transition: all 0.3s ease-out;
            pointer-events: none;
        }
    </style>
</head>
<body>
<div class="sky">
<div class="floating-cat">ğŸ˜º</div>
<div class="floating-cat">ğŸ±</div>
<div class="floating-cat">ğŸ˜¸</div>
<div class="floating-cat">ğŸ™€</div>
<div class="floating-cat">ğŸ˜»</div>
<div class="floating-cat" style="top:75%;right:30%;animation-delay:4s;font-size:2.2rem;">ğŸˆ</div>
<div class="floating-cat" style="top:15%;left:50%;animation-delay:2.5s;font-size:3.5rem;">ğŸˆâ€â¬›</div>
<div class="floating-cat" style="top:50%;left:40%;animation-delay:1.5s;font-size:2.8rem;">ğŸ˜½</div>
</div>
<div class="main-content">
<h1>ğŸ¾ Cat Paradise ğŸ¾</h1>
<p class="subtitle">Where every pixel is purrfect~</p>
<div class="arena-container" style="display:flex;flex-direction:column;align-items:center;margin-top:20px;">
<div class="spectator-row top-spectators" style="display:flex;gap:10px;margin-bottom:15px;">
</div>
<div class="arena-with-sides" style="display:flex;align-items:center;gap:15px;">
<div class="side-spectators left-side" style="display:flex;flex-direction:column;gap:10px;">
</div>
<div class="battle-arena" style="margin:0;">
<h2>âš”ï¸ Cat vs Dog Battle Arena âš”ï¸</h2>
<p style="color:#8b7d8b;margin-bottom:10px;">ğŸ± Cats defend the paradise! ğŸ• Dogs invade! Watch the epic auto-battle! âš”ï¸</p>
<canvas height="280" id="battle-canvas" width="650"></canvas>
<div class="battle-stats">
<span class="cat-score">ğŸ± Cats: <span id="cat-wins">0</span></span>
<span class="vs-text">VS</span>
<span class="dog-score">ğŸ• Dogs: <span id="dog-wins">0</span></span>
</div>
</div>
<div class="side-spectators right-side" style="display:flex;flex-direction:column;gap:10px;">
</div>
</div>
<div class="spectator-row bottom-spectators" style="display:flex;gap:10px;margin-top:15px;">
</div>
</div>
<div class="cat-gallery" style="display:none;">
<div class="cat-card">
<div class="emoji">ğŸ˜º</div>
<h3>Whiskers</h3>
<p>Chief Nap Officer</p>
</div>
<div class="cat-card">
<div class="emoji">ğŸ˜¸</div>
<h3>Mittens</h3>
<p>Treat Inspector</p>
</div>
<div class="cat-card">
<div class="emoji">ğŸ±</div>
<h3>Shadow</h3>
<p>Box Enthusiast</p>
</div>
<div class="cat-card">
<div class="emoji">ğŸ˜»</div>
<h3>Luna</h3>
<p>Cuddle Expert</p>
</div>
<div class="cat-card">
<div class="emoji">ğŸˆ</div>
<h3>Biscuit</h3>
<p>Kneading Master</p>
</div>
<div class="cat-card">
<div class="emoji">ğŸˆâ€â¬›</div>
<h3>Pixel</h3>
<p>Keyboard Walker</p>
</div>
<div class="cat-card">
<div class="emoji">ğŸ˜½</div>
<h3>Mochi</h3>
<p>Sunbeam Chaser</p>
</div>
<div class="cat-card">
<div class="emoji">ğŸ˜¼</div>
<h3>Gizmo</h3>
<p>Zoomie Champion</p>
</div>
<div class="cat-card weird-cat" id="chat-cat">
<div class="emoji" style="filter: hue-rotate(180deg) saturate(1.5);">ğŸ™€</div>
<h3>Echo</h3>
<p>Chat Mimic</p>
<div class="chat-bubble" id="echo-bubble">Waiting for chat...</div>
</div>
</div>
<div class="community-zone">
<h2>âœ¨ Community Cat Corner âœ¨</h2>
<p>ğŸ‰ The cat family is growing! 9 adorable felines now call this paradise home! ğŸ‰</p>
<p style="margin-top:10px;font-size:0.9rem;">ğŸ’¬ Echo the weird cat repeats everything from chat! ğŸ™€âœ¨</p>
<p style="margin-top:5px;font-size:0.8rem;color:#00bcd4;">ğŸ’¬ Echo shows the latest chat message (ignores @ mentions)! ğŸ—¨ï¸ğŸ±</p>
<p style="margin-top:5px;font-size:0.75rem;color:#999;">ğŸ¾ Cat interactions now happen every 25-45 seconds for ultra zen vibes! ğŸ§˜â€â™€ï¸ğŸ¾</p>
<p style="margin-top:5px;font-size:0.8rem;color:#d4798b;">ğŸ­ Click any cat to see their mood change! Each meow brings a new expression! ğŸ˜ºğŸ˜»ğŸ˜¼</p>
<p style="margin-top:8px;font-size:0.9rem;color:#ff69b4;font-weight:bold;">ğŸ“£ The cats are now SPECTATORS around the battle arena! Cheer them on! ğŸ‰ğŸ±</p>
</div>
</div>
<div class="paw-prints">
<span class="paw">ğŸ¾</span>
<span class="paw">ğŸ¾</span>
<span class="paw">ğŸ¾</span>
<span class="paw">ğŸ¾</span>
<span class="paw">ğŸ¾</span>
<span class="paw">ğŸ¾</span>
<span class="paw">ğŸ¾</span>
</div>
<script>
        document.querySelectorAll('.cat-card').forEach(card => {
            card.addEventListener('click', () => {
                card.style.animation = 'none';
                card.offsetHeight;
                card.style.animation = 'wiggle 0.5s ease-in-out';
                
                // Mood-based meows with matching expressions
                const moodMeows = [
                    { msg: 'Meow!', emoji: 'ğŸ˜º', mood: 'happy' },
                    { msg: 'Purrrr~', emoji: 'ğŸ˜»', mood: 'love' },
                    { msg: 'Mrrp?', emoji: 'ğŸ™€', mood: 'curious' },
                    { msg: 'Nya~', emoji: 'ğŸ˜¸', mood: 'playful' },
                    { msg: '*head bonk*', emoji: 'ğŸ˜½', mood: 'affectionate' },
                    { msg: '*yawns*', emoji: 'ğŸ˜¿', mood: 'sleepy' },
                    { msg: 'HISS!', emoji: 'ğŸ™€', mood: 'angry' },
                    { msg: '*happy chirp*', emoji: 'ğŸ˜¸', mood: 'excited' },
                    { msg: '*slow blink*', emoji: 'ğŸ˜»', mood: 'trusting' },
                    { msg: 'Mrow?!', emoji: 'ğŸ™€', mood: 'surprised' },
                    { msg: '*smug look*', emoji: 'ğŸ˜¼', mood: 'smug' },
                    { msg: '*kneads paws*', emoji: 'ğŸ˜º', mood: 'content' }
                ];
                
                const choice = moodMeows[Math.floor(Math.random() * moodMeows.length)];
                const emojiEl = card.querySelector('.emoji');
                const originalEmoji = emojiEl.textContent;
                
                // Temporarily change emoji to match mood
                emojiEl.textContent = choice.emoji;
                emojiEl.style.transition = 'transform 0.3s ease';
                emojiEl.style.transform = 'scale(1.2)';
                
                // Create speech bubble with mood message
                const bubble = document.createElement('div');
                bubble.textContent = choice.msg;
                bubble.style.cssText = 'position:absolute;background:#fff;padding:8px 15px;border-radius:15px;font-size:1rem;box-shadow:0 3px 10px rgba(0,0,0,0.2);animation:fadeUp 1.5s forwards;pointer-events:none;z-index:5;';
                card.style.position = 'relative';
                card.appendChild(bubble);
                
                // Restore original emoji after animation
                setTimeout(() => {
                    bubble.remove();
                    emojiEl.style.transform = 'scale(1)';
                    setTimeout(() => {
                        emojiEl.textContent = originalEmoji;
                    }, 300);
                }, 1500);
            });
        });
        
        const style = document.createElement('style');
        style.textContent = '@keyframes fadeUp{0%{opacity:1;top:-10px;}100%{opacity:0;top:-50px;}}';
        document.head.appendChild(style);
        
        // Distribute cat cards around the battle arena as spectators!
        const catCards = document.querySelectorAll('.cat-gallery .cat-card');
        const topRow = document.querySelector('.top-spectators');
        const bottomRow = document.querySelector('.bottom-spectators');
        const leftSide = document.querySelector('.left-side');
        const rightSide = document.querySelector('.right-side');
        
        // Distribute cards: 2 top, 3 left, 3 right, 1 bottom (more visible on sides!)
        const cardArray = Array.from(catCards);
        cardArray.forEach((card, i) => {
            card.style.width = '130px';
            card.style.padding = '10px';
            card.querySelector('.emoji').style.fontSize = '2.2rem';
            card.querySelector('h3').style.fontSize = '0.85rem';
            card.querySelector('p').style.fontSize = '0.65rem';
            
            if (i < 2) topRow.appendChild(card);
            else if (i < 5) leftSide.appendChild(card);
            else if (i < 8) rightSide.appendChild(card);
            else bottomRow.appendChild(card);
        });
        
        // Add cheering animations to spectator cards
        const spectatorStyle = document.createElement('style');
        spectatorStyle.textContent = `
            .spectator-row .cat-card, .side-spectators .cat-card {
                animation: spectatorCheer 2s ease-in-out infinite;
            }
            .left-side .cat-card { animation-delay: 0.3s; }
            .right-side .cat-card { animation-delay: 0.6s; }
            .bottom-spectators .cat-card { animation-delay: 0.9s; }
            @keyframes spectatorCheer {
                0%, 100% { transform: translateY(0) rotate(0); }
                25% { transform: translateY(-5px) rotate(-3deg); }
                75% { transform: translateY(-3px) rotate(3deg); }
            }
            .arena-container { max-width: 95vw; }
            .side-spectators .cat-card { 
                width: 125px !important; 
                background: rgba(255,255,255,0.95) !important;
                box-shadow: 0 5px 20px rgba(0,0,0,0.15) !important;
            }
            .side-spectators .emoji { font-size: 2.2rem !important; }
            .left-side, .right-side {
                padding: 10px;
                background: rgba(255,182,193,0.4);
                border-radius: 15px;
                box-shadow: 0 0 20px rgba(255,182,193,0.5);
            }
            .spectator-row .cat-card, .side-spectators .cat-card {
                border: 3px solid #ffb6c1 !important;
                box-shadow: 0 5px 25px rgba(255,105,180,0.4) !important;
            }
            .top-spectators, .bottom-spectators {
                background: rgba(255,182,193,0.3);
                padding: 10px 20px;
                border-radius: 15px;
            }
        `;
        document.head.appendChild(spectatorStyle);
        
        // Cat Card Interactions System
        const catCards = document.querySelectorAll('.cat-card');
        const interactions = [
            ['ğŸ’•', 'ğŸ˜» So cute!'],
            ['ğŸŸ', 'Want some fish?'],
            ['ğŸ’­', 'Thinking of you~'],
            ['ğŸ§¶', "Let's play!"],
            ['ğŸ˜´', 'Nap together?'],
            ['ğŸ¾', '*paw bump*'],
            ['ğŸ’–', 'Best friends!'],
            ['ğŸŒŸ', 'You shine!'],
            ['ğŸ£', 'Sushi time!'],
            ['ğŸ€', 'Looking fancy~'],
            ['ğŸŒ™', 'Moon gazing?'],
            ['â˜€ï¸', 'Sunny vibes!'],
            ['ğŸ¦‹', 'Chase butterflies!'],
            ['ğŸµ', '*purrs a melody*'],
            ['ğŸ§', 'Sweet like you!'],
            ['ğŸª´', 'Plant nibbling?'],
            ['ğŸ“¦', 'Box party!'],
            ['ğŸ§£', 'Cozy times~'],
            ['ğŸ', 'Surprise gift!'],
            ['ğŸƒ', 'Leaf attack!'],
            ['ğŸ‘€', '*stares intensely*'],
            ['ğŸ­', 'Mouse spotted!'],
            ['ğŸŒˆ', 'Rainbow dreams~'],
            ['â­', 'Starlight friend!'],
            ['ğŸª', 'Circus tricks!'],
            ['ğŸ›‹ï¸', 'Couch conquest!'],
            ['ğŸª', 'Mirror enemy!'],
            ['ğŸ­', 'Drama queen!'],
            ['ğŸ§Š', 'Ice cube chase!'],
            ['ğŸ“º', 'Bird TV time!'],
            ['ğŸ¸', 'Rock meow!'],
            ['ğŸ•', 'Pizza slice!'],
            ['ğŸŒº', 'Flower crown!'],
            ['ğŸ¦´', 'Dog impressions!'],
            ['ğŸˆ', 'Balloon pop!'],
            ['ğŸ§²', 'Magnet paws!'],
            ['ğŸ””', '*ding ding*'],
            ['ğŸ’¤', 'Sleepy boi~'],
            ['ğŸŒŠ', 'Water fear!'],
            ['ğŸ†', 'Champion cat!']
        ];
        
        function createHeartTrail(fromCard, toCard) {
            const fromRect = fromCard.getBoundingClientRect();
            const toRect = toCard.getBoundingClientRect();
            
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const heart = document.createElement('span');
                    heart.className = 'heart-trail';
                    heart.textContent = 'ğŸ’•';
                    heart.style.left = (fromRect.left + fromRect.width/2 + (toRect.left - fromRect.left) * (i/3)) + 'px';
                    heart.style.top = (fromRect.top + (toRect.top - fromRect.top) * (i/3)) + 'px';
                    document.body.appendChild(heart);
                    setTimeout(() => heart.remove(), 1500);
                }, i * 200);
            }
        }
        
        function catInteraction() {
            const cards = Array.from(catCards);
            const fromIdx = Math.floor(Math.random() * cards.length);
            let toIdx = Math.floor(Math.random() * cards.length);
            while (toIdx === fromIdx) toIdx = Math.floor(Math.random() * cards.length);
            
            const fromCard = cards[fromIdx];
            const toCard = cards[toIdx];
            const [emoji, message] = interactions[Math.floor(Math.random() * interactions.length)];
            
            fromCard.classList.add('visiting');
            setTimeout(() => fromCard.classList.remove('visiting'), 600);
            
            createHeartTrail(fromCard, toCard);
            
            setTimeout(() => {
                toCard.classList.add('visiting');
                const bubble = document.createElement('div');
                bubble.className = 'interaction-bubble';
                bubble.textContent = emoji + ' ' + message;
                toCard.style.position = 'relative';
                toCard.appendChild(bubble);
                setTimeout(() => {
                    bubble.remove();
                    toCard.classList.remove('visiting');
                }, 2000);
            }, 500);
        }
        
        // ===== CAT VS DOG BATTLE SYSTEM =====
        const battleCanvas = document.getElementById('battle-canvas');
        const battleCtx = battleCanvas.getContext('2d');
        let catWins = 0;
        let dogWins = 0;
        
        const catEmojis = ['ğŸ˜º', 'ğŸ˜¸', 'ğŸ±', 'ğŸ˜»', 'ğŸˆ', 'ğŸ˜¼'];
        const dogEmojis = ['ğŸ•', 'ğŸ¶', 'ğŸ©', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸ¾'];
        
        class BattleUnit {
            constructor(team, x) {
                this.team = team;
                this.x = x;
                this.y = 100 + Math.random() * 120;
                this.hp = 100;
                this.maxHp = 100;
                this.speed = 0.8 + Math.random() * 0.6;
                this.attackPower = 15 + Math.random() * 10;
                this.attackCooldown = 0;
                this.emoji = team === 'cat' 
                    ? catEmojis[Math.floor(Math.random() * catEmojis.length)]
                    : dogEmojis[Math.floor(Math.random() * dogEmojis.length)];
                this.size = 28 + Math.random() * 8;
                this.bobOffset = Math.random() * Math.PI * 2;
            }
            
            update(enemies) {
                this.bobOffset += 0.1;
                if (this.attackCooldown > 0) this.attackCooldown--;
                
                // Find nearest enemy
                let nearest = null;
                let nearestDist = Infinity;
                enemies.forEach(e => {
                    const dist = Math.abs(e.x - this.x);
                    if (dist < nearestDist) {
                        nearestDist = dist;
                        nearest = e;
                    }
                });
                
                if (nearest) {
                    if (nearestDist < 40) {
                        // Attack!
                        if (this.attackCooldown <= 0) {
                            nearest.hp -= this.attackPower;
                            this.attackCooldown = 30;
                        }
                    } else {
                        // Move toward enemy
                        this.x += (this.team === 'cat' ? this.speed : -this.speed);
                    }
                } else {
                    // No enemies, advance!
                    this.x += (this.team === 'cat' ? this.speed * 0.5 : -this.speed * 0.5);
                }
            }
            
            draw(ctx) {
                const bobY = Math.sin(this.bobOffset) * 3;
                
                // Health bar
                const barWidth = 30;
                const barHeight = 4;
                ctx.fillStyle = '#333';
                ctx.fillRect(this.x - barWidth/2, this.y - 25 + bobY, barWidth, barHeight);
                ctx.fillStyle = this.team === 'cat' ? '#e74c3c' : '#3498db';
                ctx.fillRect(this.x - barWidth/2, this.y - 25 + bobY, barWidth * (this.hp / this.maxHp), barHeight);
                
                // Unit emoji
                ctx.font = `${this.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.emoji, this.x, this.y + bobY);
                
                // Attack flash
                if (this.attackCooldown > 25) {
                    ctx.font = '15px Arial';
                    ctx.fillText('ğŸ’¥', this.x + (this.team === 'cat' ? 20 : -20), this.y - 10 + bobY);
                }
            }
        }
        
        let cats = [];
        let dogs = [];
        
        function spawnUnits() {
            if (cats.length < 4) cats.push(new BattleUnit('cat', 30 + Math.random() * 50));
            if (dogs.length < 4) dogs.push(new BattleUnit('dog', battleCanvas.width - 30 - Math.random() * 50));
        }
        
        // Initial spawn
        for (let i = 0; i < 3; i++) {
            cats.push(new BattleUnit('cat', 30 + i * 40));
            dogs.push(new BattleUnit('dog', battleCanvas.width - 30 - i * 40));
        }
        
        function battleLoop() {
            battleCtx.clearRect(0, 0, battleCanvas.width, battleCanvas.height);
            
            // Draw battlefield grass
            battleCtx.fillStyle = 'rgba(34, 139, 34, 0.3)';
            for (let i = 0; i < 20; i++) {
                battleCtx.fillRect(i * 35, battleCanvas.height - 20, 3, 15);
            }
            
            // Update units
            cats.forEach(c => c.update(dogs));
            dogs.forEach(d => d.update(cats));
            
            // Remove dead units
            const deadCats = cats.filter(c => c.hp <= 0).length;
            const deadDogs = dogs.filter(d => d.hp <= 0).length;
            cats = cats.filter(c => c.hp > 0);
            dogs = dogs.filter(d => d.hp > 0);
            
            // Score updates
            if (deadDogs > 0) {
                catWins += deadDogs;
                document.getElementById('cat-wins').textContent = catWins;
            }
            if (deadCats > 0) {
                dogWins += deadCats;
                document.getElementById('dog-wins').textContent = dogWins;
            }
            
            // Draw all units
            cats.forEach(c => c.draw(battleCtx));
            dogs.forEach(d => d.draw(battleCtx));
            
            // Draw team labels
            battleCtx.font = 'bold 14px Comic Sans MS';
            battleCtx.fillStyle = '#e74c3c';
            battleCtx.textAlign = 'left';
            battleCtx.fillText('ğŸ± CAT ARMY', 10, 20);
            battleCtx.fillStyle = '#3498db';
            battleCtx.textAlign = 'right';
            battleCtx.fillText('DOG INVADERS ğŸ•', battleCanvas.width - 10, 20);
            
            requestAnimationFrame(battleLoop);
        }
        
        battleLoop();
        setInterval(spawnUnits, 3000); // Spawn new units every 3 seconds
        
        // Start cat interactions every 25-45 seconds (ultra calm mode per community request)
        setInterval(catInteraction, 25000 + Math.random() * 20000);
        setTimeout(catInteraction, 1000); // First interaction after 1 second
        
        // Chat Mimic Cat - Echo!
        const echoBubble = document.getElementById('echo-bubble');
        const chatCat = document.getElementById('chat-cat');
        const echoMessages = [];
        
        function updateEchoBubble(message, username) {
            const displayText = username ? `${username}: ${message}` : message;
            echoBubble.textContent = displayText.substring(0, 50) + (displayText.length > 50 ? '...' : '');
            echoBubble.classList.remove('new-message');
            void echoBubble.offsetWidth; // Trigger reflow
            echoBubble.classList.add('new-message');
            chatCat.classList.add('visiting');
            setTimeout(() => chatCat.classList.remove('visiting'), 600);
        }
        
        // Connect to live chat WebSocket
        try {
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const pathBase = location.pathname.includes('/twitch_plays_code') ? '/twitch_plays_code' : 
                           location.pathname.includes('/tpc') ? '/twitch_plays_code' : '';
            const chatWs = new WebSocket(`${wsProtocol}//${location.host}${pathBase}/ws/chat`);
            
            chatWs.onopen = () => {
                updateEchoBubble('ğŸ¤ Connected! Say something!');
            };
            
            chatWs.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                if (msg.type === 'chat_message') {
                    // Skip messages containing @ (mentions/commands)
                    if (msg.message && msg.message.includes('@')) {
                        return; // Echo ignores @ messages! ğŸ™€
                    }
                    echoMessages.push({message: msg.message, username: msg.username});
                    if (echoMessages.length > 20) echoMessages.shift(); // Keep last 20
                    updateEchoBubble(msg.message, msg.username);
                }
                if (msg.type === 'chat_history' && msg.messages && msg.messages.length > 0) {
                    // Only show the very last message from history
                    const lastMsg = msg.messages[msg.messages.length - 1];
                    updateEchoBubble(lastMsg.message, lastMsg.username);
                }
            };
            
            chatWs.onerror = () => {
                updateEchoBubble('ğŸ˜¿ Chat unavailable');
            };
            
            chatWs.onclose = () => {
                updateEchoBubble('ğŸ˜¿ Disconnected...');
            };
        } catch (err) {
            updateEchoBubble('ğŸ˜¿ No chat connection');
        }
    </script>
</body>
</html>