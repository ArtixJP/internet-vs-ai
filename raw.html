<!DOCTYPE html>

<html>
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://esm.run https://cdn.tailwindcss.com https://threejs.org https://cdn.threejs.org https://cdn.p5js.org https://code.jquery.com https://d3js.org https://cdn.plot.ly https://cdn.tonejs.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: https:; media-src 'self' https:; font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; worker-src 'self'; frame-src https://www.youtube.com https://www.youtube-nocookie.com https://player.vimeo.com; connect-src 'self' https: wss: ws:; object-src 'none'; base-uri 'self'; form-action 'self';">
<title>Space Odyssey</title>
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            min-height: 100vh;
            background: radial-gradient(ellipse at bottom, #1b2838 0%, #090a0f 100%);
            overflow: hidden;
            perspective: 1000px;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        .stars {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 230px 80px, #fff, transparent),
                radial-gradient(2px 2px at 300px 200px, #fff, transparent),
                radial-gradient(1px 1px at 400px 50px, rgba(255,255,255,0.7), transparent),
                radial-gradient(2px 2px at 500px 150px, #fff, transparent);
            background-size: 550px 300px;
            animation: twinkle 4s ease-in-out infinite;
        }
        @keyframes twinkle { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        .space-scene {
            position: relative;
            width: 100vw;
            height: 100vh;
            transform-style: preserve-3d;
        }
        .rocket {
            position: absolute;
            left: 50%; top: 50%;
            font-size: 80px;
            filter: drop-shadow(0 0 30px rgba(255,100,50,0.8));
            cursor: pointer;
            transition: left 0.4s ease-out, top 0.4s ease-out, transform 0.3s;
            z-index: 10;
        }
        .rocket:hover { transform: translate(-50%, -50%) scale(1.2); }
        .rocket.moving-up { transform: translate(-50%, -50%) rotate(-15deg); }
        .rocket.moving-down { transform: translate(-50%, -50%) rotate(165deg); }
        .rocket.moving-left { transform: translate(-50%, -50%) rotate(-75deg); }
        .rocket.moving-right { transform: translate(-50%, -50%) rotate(75deg); }
        .flame {
            position: absolute;
            width: 30px; height: 60px;
            background: linear-gradient(to bottom, #ff6b35, #f7931e, transparent);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: flameFlicker 0.15s infinite;
            filter: blur(3px);
            pointer-events: none;
            z-index: 9;
            transition: left 0.4s ease-out, top 0.4s ease-out;
        }
        .chat-command {
            position: fixed;
            bottom: 80px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,212,255,0.2);
            border: 1px solid rgba(0,212,255,0.5);
            padding: 8px 20px;
            border-radius: 20px;
            color: #00d4ff;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }
        .chat-command.visible { opacity: 1; }
        @keyframes flameFlicker { 0%,100% { height: 60px; opacity: 1; } 50% { height: 70px; opacity: 0.8; } }
        .planet {
            position: absolute;
            border-radius: 50%;
            animation: orbit linear infinite;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .planet:hover { transform: scale(1.3); box-shadow: 0 0 40px currentColor; }
        .planet-emoji {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8em;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
            animation: emojiFloat 3s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes emojiFloat {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -55%) scale(1.1); }
        }
        .planet-emoji {
            transition: transform 0.3s ease-out, opacity 0.15s ease-out;
        }
        .planet-1 {
            width: 100px; height: 100px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 50%, #922b21 100%);
            top: 15%; left: 10%;
            animation-duration: 20s;
            box-shadow: inset -20px -10px 30px rgba(0,0,0,0.5), 0 0 20px rgba(231,76,60,0.5);
        }
        .planet-2 {
            width: 150px; height: 150px;
            background: linear-gradient(135deg, #f39c12 0%, #d68910 50%, #b9770e 100%);
            top: 60%; right: 8%;
            animation-duration: 25s;
            box-shadow: inset -30px -15px 40px rgba(0,0,0,0.4), 0 0 30px rgba(243,156,18,0.4);
        }
        .planet-2::after {
            content: ''; position: absolute;
            width: 200px; height: 20px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotateX(75deg);
        }
        .planet-3 {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 50%, #1a5276 100%);
            top: 75%; left: 20%;
            animation-duration: 15s;
            box-shadow: inset -15px -8px 20px rgba(0,0,0,0.5), 0 0 15px rgba(52,152,219,0.5);
        }
        .title {
            position: absolute;
            top: 5%; left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 20;
        }
        .title h1 {
            font-size: 3rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf, #ff006e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(123,44,191,0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow { from { filter: brightness(1); } to { filter: brightness(1.2); } }
        .title p {
            color: rgba(255,255,255,0.7);
            font-size: 1.1rem;
            margin-top: 10px;
        }
        .community-zone {
            position: absolute;
            bottom: 5%; left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            text-align: center;
            z-index: 20;
        }
        .community-zone span { opacity: 0.7; font-size: 0.9rem; }
        .meteor {
            position: absolute;
            font-size: 40px;
            z-index: 5;
            pointer-events: none;
            filter: drop-shadow(0 0 15px #ff4500) drop-shadow(0 0 30px #ff6b35);
            animation: meteorFall linear forwards;
        }
        .spacex-ship {
            position: absolute;
            right: -200px;
            font-size: 60px;
            z-index: 15;
            pointer-events: none;
            animation: spacexFly 20s linear infinite;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.5));
        }
        .spacex-ship::before {
            content: 'üßë‚ÄçüöÄ';
            position: absolute;
            font-size: 20px;
            top: 5px;
            left: 25px;
            animation: elonWave 0.5s ease-in-out infinite;
        }
        .spacex-ship::after {
            content: 'SpaceX';
            position: absolute;
            font-size: 10px;
            color: #fff;
            font-weight: bold;
            top: 35px;
            left: 15px;
            text-shadow: 0 0 5px #00d4ff;
        }
        .elon-label {
            position: absolute;
            font-size: 12px;
            color: #00d4ff;
            white-space: nowrap;
            animation: spacexFly 20s linear infinite;
            right: -200px;
            pointer-events: none;
            z-index: 16;
        }
        @keyframes spacexFly {
            0% { right: -200px; top: 30%; transform: rotate(-5deg); }
            25% { top: 45%; transform: rotate(0deg); }
            50% { top: 35%; transform: rotate(3deg); }
            75% { top: 50%; transform: rotate(-2deg); }
            100% { right: 110%; top: 40%; transform: rotate(-5deg); }
        }
        @keyframes elonWave {
            0%, 100% { transform: rotate(-10deg); }
            50% { transform: rotate(10deg); }
        }
        .meteor::after {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 80px;
            background: linear-gradient(to top, transparent, #ff6b35, #ff4500, #fff);
            border-radius: 50%;
            filter: blur(4px);
            opacity: 0.8;
        }
        @keyframes meteorFall {
            0% {
                transform: translateY(-50px) rotate(15deg) scale(0.8);
                opacity: 0;
            }
            5% {
                opacity: 1;
                transform: translateY(0) rotate(15deg) scale(1);
            }
            85% {
                opacity: 1;
            }
            100% {
                transform: translateY(110vh) rotate(20deg) scale(0.9);
                opacity: 0;
            }
        }
        @keyframes orbit {
            from { transform: rotate(0deg) translateX(10px) rotate(0deg); }
            to { transform: rotate(360deg) translateX(10px) rotate(-360deg); }
        }
    </style>
</head>
<body>
<div class="stars"></div>
<div class="space-scene">
<div class="title">
<h1>üåå Space Odyssey</h1>
<p>Explore the cosmos together</p>
</div>
<div class="rocket">üöÄ</div>
<div class="flame"></div>
<div class="planet planet-1" title="Mars"><span class="planet-emoji" id="emoji1"></span></div>
<div class="planet planet-2" title="Saturn"><span class="planet-emoji" id="emoji2"></span></div>
<div class="planet planet-3" title="Neptune"><span class="planet-emoji" id="emoji3"></span></div>
<div class="spacex-ship">üõ∏</div>
<div class="elon-label" style="animation-delay: 0s;">üëã Elon says: "To Mars!"</div>
<div class="community-zone">
<span>üéÆ Type UP / DOWN / LEFT / RIGHT in chat to control the rocket! üöÄ ‚òÑÔ∏è Watch for meteors! üõ∏ SpaceX passing by!</span>
</div>
<div class="chat-command" id="chatCommand"></div>
</div>
<script>
(function() {
    const rocket = document.querySelector('.rocket');
    const flame = document.querySelector('.flame');
    const chatCmd = document.getElementById('chatCommand');
    
    let rocketX = 50;
    let rocketY = 50;
    const step = 8;
    const bounds = { minX: 10, maxX: 90, minY: 15, maxY: 85 };
    
    function updateRocket() {
        rocket.style.left = rocketX + '%';
        rocket.style.top = rocketY + '%';
        rocket.style.transform = 'translate(-50%, -50%)';
        flame.style.left = rocketX + '%';
        flame.style.top = (rocketY + 5) + '%';
        flame.style.transform = 'translate(-50%, 0)';
    }
    
    function showCommand(user, cmd) {
        chatCmd.textContent = `${user}: ${cmd.toUpperCase()}`;
        chatCmd.classList.add('visible');
        setTimeout(() => chatCmd.classList.remove('visible'), 1500);
    }
    
    function moveRocket(direction, user) {
        rocket.className = 'rocket';
        switch(direction) {
            case 'up':
                rocketY = Math.max(bounds.minY, rocketY - step);
                rocket.classList.add('moving-up');
                break;
            case 'down':
                rocketY = Math.min(bounds.maxY, rocketY + step);
                rocket.classList.add('moving-down');
                break;
            case 'left':
                rocketX = Math.max(bounds.minX, rocketX - step);
                rocket.classList.add('moving-left');
                break;
            case 'right':
                rocketX = Math.min(bounds.maxX, rocketX + step);
                rocket.classList.add('moving-right');
                break;
        }
        updateRocket();
        showCommand(user, direction);
        setTimeout(() => {
            rocket.className = 'rocket';
            checkPlanetCollision();
        }, 400);
    }
    
    updateRocket();
    
    const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const pathBase = location.pathname.includes('/twitch_plays_code') ? '/twitch_plays_code' : 
                     location.pathname.includes('/tpc') ? '/twitch_plays_code' : '';
    const chatWs = new WebSocket(`${wsProtocol}//${location.host}${pathBase}/ws/chat`);
    
    chatWs.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'chat_message') {
            const text = msg.message.toLowerCase().trim();
            if (['up', 'down', 'left', 'right'].includes(text)) {
                moveRocket(text, msg.username);
            }
        }
    };
    
    chatWs.onerror = () => console.log('Chat connection error');
    chatWs.onclose = () => setTimeout(() => location.reload(), 5000);
    
    // Sound system for planet contact
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playPlanetSound(planetType) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        const osc2 = audioCtx.createOscillator();
        
        osc.connect(gain);
        osc2.connect(gain);
        gain.connect(audioCtx.destination);
        
        // Different sounds for different planets
        const sounds = {
            mars: { freq: 440, freq2: 550, type: 'sine' },
            saturn: { freq: 330, freq2: 415, type: 'triangle' },
            neptune: { freq: 523, freq2: 659, type: 'sine' }
        };
        
        const sound = sounds[planetType] || sounds.mars;
        osc.type = sound.type;
        osc2.type = 'sine';
        osc.frequency.setValueAtTime(sound.freq, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(sound.freq * 1.5, audioCtx.currentTime + 0.1);
        osc.frequency.exponentialRampToValueAtTime(sound.freq * 0.5, audioCtx.currentTime + 0.3);
        osc2.frequency.setValueAtTime(sound.freq2, audioCtx.currentTime);
        osc2.frequency.exponentialRampToValueAtTime(sound.freq2 * 1.2, audioCtx.currentTime + 0.2);
        
        gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
        
        osc.start(audioCtx.currentTime);
        osc2.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + 0.4);
        osc2.stop(audioCtx.currentTime + 0.4);
    }
    
    function checkPlanetCollision() {
        const planets = [
            { el: document.querySelector('.planet-1'), name: 'mars' },
            { el: document.querySelector('.planet-2'), name: 'saturn' },
            { el: document.querySelector('.planet-3'), name: 'neptune' }
        ];
        
        const rocketRect = rocket.getBoundingClientRect();
        const rocketCenterX = rocketRect.left + rocketRect.width / 2;
        const rocketCenterY = rocketRect.top + rocketRect.height / 2;
        
        planets.forEach(planet => {
            const planetRect = planet.el.getBoundingClientRect();
            const planetCenterX = planetRect.left + planetRect.width / 2;
            const planetCenterY = planetRect.top + planetRect.height / 2;
            const planetRadius = planetRect.width / 2;
            
            const distance = Math.sqrt(
                Math.pow(rocketCenterX - planetCenterX, 2) + 
                Math.pow(rocketCenterY - planetCenterY, 2)
            );
            
            if (distance < planetRadius + 40 && !planet.el.dataset.touched) {
                planet.el.dataset.touched = 'true';
                playPlanetSound(planet.name);
                planet.el.style.animation = 'none';
                planet.el.style.transform = 'scale(1.4)';
                planet.el.style.boxShadow = '0 0 60px currentColor';
                setTimeout(() => {
                    planet.el.style.transform = '';
                    planet.el.style.boxShadow = '';
                    planet.el.style.animation = '';
                    delete planet.el.dataset.touched;
                }, 500);
            }
        });
    }
    
    // Random planet emojis
    const marsEmojis = ['üëΩ', 'ü¶†', 'üî¥', 'üèúÔ∏è', 'üåã', 'üëæ'];
    const saturnEmojis = ['üíç', 'ü™ê', 'üåô', '‚≠ê', '‚ú®', 'üîÆ'];
    const neptuneEmojis = ['‚ùÑÔ∏è', 'üßä', 'üíé', 'üåä', 'üîµ', 'üí†'];
    
    // Track last used emojis to ensure variety
    const lastEmojis = { mars: -1, saturn: -1, neptune: -1 };
    
    function randomEmoji(arr, planetKey) {
        let newIndex;
        do {
            newIndex = Math.floor(Math.random() * arr.length);
        } while (newIndex === lastEmojis[planetKey] && arr.length > 1);
        lastEmojis[planetKey] = newIndex;
        return arr[newIndex];
    }
    
    document.getElementById('emoji1').textContent = randomEmoji(marsEmojis, 'mars');
    document.getElementById('emoji2').textContent = randomEmoji(saturnEmojis, 'saturn');
    document.getElementById('emoji3').textContent = randomEmoji(neptuneEmojis, 'neptune');
    
    // Change emojis periodically with visual feedback
    function changeEmojiWithEffect(element, emoji) {
        element.style.transform = 'translate(-50%, -50%) scale(0)';
        element.style.opacity = '0';
        setTimeout(() => {
            element.textContent = emoji;
            element.style.transform = 'translate(-50%, -50%) scale(1.3)';
            element.style.opacity = '1';
            setTimeout(() => {
                element.style.transform = '';
            }, 200);
        }, 150);
    }
    
    setInterval(() => {
        changeEmojiWithEffect(document.getElementById('emoji1'), randomEmoji(marsEmojis, 'mars'));
        setTimeout(() => {
            changeEmojiWithEffect(document.getElementById('emoji2'), randomEmoji(saturnEmojis, 'saturn'));
        }, 300);
        setTimeout(() => {
            changeEmojiWithEffect(document.getElementById('emoji3'), randomEmoji(neptuneEmojis, 'neptune'));
        }, 600);
    }, 5000);
    // Meteor shower system
    function spawnMeteor() {
        const meteor = document.createElement('div');
        meteor.className = 'meteor';
        meteor.textContent = '‚òÑÔ∏è';
        
        // Random horizontal position (10% to 90% to stay visible)
        const xPos = 10 + Math.random() * 80;
        meteor.style.left = xPos + '%';
        meteor.style.top = '-50px';
        
        // Slow, graceful fall duration (8-14 seconds)
        const duration = 8 + Math.random() * 6;
        meteor.style.animationDuration = duration + 's';
        
        // Slight random rotation
        const rotation = 10 + Math.random() * 20;
        meteor.style.setProperty('--rotation', rotation + 'deg');
        
        document.querySelector('.space-scene').appendChild(meteor);
        
        // Play meteor sound
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(200, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.5);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + 0.5);
        
        // Remove meteor after animation
        setTimeout(() => {
            meteor.remove();
        }, duration * 1000 + 100);
    }
    
    // Spawn meteors slowly and peacefully (every 8-15 seconds)
    function scheduleMeteor() {
        spawnMeteor();
        const nextDelay = 8000 + Math.random() * 7000;
        setTimeout(scheduleMeteor, nextDelay);
    }
    
    // Start meteor shower after a short delay
    setTimeout(scheduleMeteor, 2000);
})();
</script>
</body>
</html>